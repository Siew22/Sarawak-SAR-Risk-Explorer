# ===================================================================
# FINAL DEMO-READY docker-compose.yml
# ===================================================================
# This version uses the 'extra_hosts' trick to ensure stable DB
# connection to the host machine without using a changing LAN IP.
# ===================================================================

services:
  # ----------------- 1. The FastAPI Backend Application -----------------
  app:
    build: .
    container_name: sar_backend_app
    restart: unless-stopped
    volumes:
      - 'C:\Users\User\.config\earthengine:/root/.config/earthengine'
    env_file:
      - .env
      
    # --- 关键修改在这里 ---
    # Manually add a host entry to the container's /etc/hosts file.
    # This maps 'host.docker.internal' to the special 'host-gateway' address,
    # which reliably points to the host machine (your Windows PC).
    # This is the most robust way to connect to a service on the host.
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ----------------- 2. The Ngrok Tunnel Service -----------------
  ngrok:
    image: ngrok/ngrok:latest
    container_name: sar_ngrok_tunnel
    restart: unless-stopped
    ports:
      - "4040:4040"
    depends_on:
      - app
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    command:
      - "http"
      - "app:8000"
      - "--domain=juliette-unattempted-tammara.ngrok-free.dev"
      - "--log=stdout"