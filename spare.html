<!DOCTYPE html>
<html lang="en">
<head>
    <title>Global SAR-Weather Risk Explorer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* CSS 与 V7.2 版本完全相同，无需修改 */
        html,body,#map{height:100%;width:100%;margin:0;padding:0;background:#1a1a1a;overflow:hidden}
        .leaflet-container{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#1a1a1a}
        .floating-panel{position:absolute;z-index:1000;background:rgba(30,30,30,.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.3);transition:all .4s cubic-bezier(.25,.8,.25,1);color:#f0f0f0}
        #control-panel{top:20px;left:20px;width:350px;padding:15px 20px}
        #result-panel{top:170px;left:20px;width:350px;max-height:calc(100vh - 190px);padding:15px 20px;overflow-y:auto;transform:translateX(-120%)}
        #result-panel.visible{transform:translateX(0)}
        #layer-panel{top:20px;right:20px;width:250px;padding:10px}
        .layer-list{list-style:none;padding:0;margin:0}
        .layer-item{padding:12px 15px;margin:5px 0;border-radius:6px;cursor:pointer;transition:background-color .2s ease;display:flex;align-items:center}
        .layer-item:hover{background-color:rgba(255,255,255,.1)}
        .layer-item.active{background-color:#0d6efd;color:#fff}
        .layer-item.inactive{color:#888;cursor:pointer;background-color:transparent!important}
        .layer-item.inactive:hover{background-color:rgba(255,255,255,.05)}
        .layer-item i{margin-right:15px;width:20px;text-align:center}
        #forecast-panel{bottom:-200px;left:50%;transform:translateX(-50%);width:80%;max-width:1200px;padding:0;border-radius:12px 12px 0 0;overflow:hidden}
        #forecast-panel.visible{bottom:0}
        #action-tooltip{position:absolute;top:135px;left:20px;background-color:#0d6efd;color:#fff;padding:10px 15px;border-radius:6px;font-size:14px;z-index:1001;opacity:0;transform:translateY(-20px);transition:opacity .3s ease,transform .3s ease;pointer-events:none}
        .temperature-label{background:rgba(0,0,0,.6);border-radius:15px;padding:3px 10px;color:#fff;font-weight:700;font-size:14px;text-align:center;white-space:nowrap;border:1px solid rgba(255,255,255,.2);box-shadow:0 2px 5px rgba(0,0,0,.3)}
        .temperature-label .city-name{font-size:12px;font-weight:400;display:block;opacity:.8}
        .daily-forecast-container{display:flex;background:rgba(40,40,40,.9)}.day-forecast{flex:1;padding:15px 10px;text-align:center;border-right:1px solid #444;cursor:pointer;transition:background-color .2s ease}.day-forecast:last-child{border-right:none}.day-forecast.active,.day-forecast:hover{background-color:#0d6efd}.day-forecast .day-name{font-weight:700;font-size:14px}.day-forecast .weather-icon{font-size:24px;margin:10px 0}.day-forecast .temp-range{font-size:14px}.hourly-forecast-container{display:none;background:rgba(20,20,20,.9);padding:15px;white-space:nowrap;overflow-x:auto}.hourly-forecast-container.visible{display:block}.hour-forecast{display:inline-block;width:80px;padding:10px;text-align:center}.hour-forecast .hour-time{font-weight:700}.hour-forecast .hour-temp{font-size:18px;margin:5px 0}#control-panel h4{margin:0 0 15px 0;color:#fff;font-size:18px}.search-container{display:flex;margin-bottom:10px}#search-input{flex-grow:1;border:1px solid #444;padding:10px;border-radius:6px 0 0 6px;background:#333;color:#fff;font-size:14px;outline:none}#search-input::placeholder{color:#888}#search-button{border:1px solid #0d6efd;background:#0d6efd;color:#fff;padding:8px 15px;border-radius:0 6px 6px 0;cursor:pointer;font-size:16px}.instructions{font-size:13px;color:#aaa;text-align:center}.location-title{font-size:18px;font-weight:700;margin-bottom:10px;color:#fff}.risk-summary{padding:15px;border-radius:8px;margin-bottom:20px;color:#fff;text-align:center}.risk-summary h2{margin:0 0 5px 0;font-size:24px;font-weight:600}.risk-summary p{margin:0;font-size:16px;opacity:.9}.risk-low{background-color:#28a745}.risk-medium{background-color:#ffc107;color:#212529}.risk-high{background-color:#dc3545}.evidence-details h4{margin-top:20px;margin-bottom:8px;font-size:16px;border-bottom:2px solid #0d6efd;padding-bottom:5px;color:#0d6efd}.evidence-details p{margin:5px 0 15px 0;line-height:1.6;font-size:14px;color:#ccc}#status-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1001;background:rgba(0,0,0,.8);color:#fff;padding:20px 30px;border-radius:10px;font-size:20px;display:none;align-items:center}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.loader{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:24px;height:24px;animation:spin 1.5s linear infinite;display:inline-block;vertical-align:middle;margin-right:15px}
    </style>
</head>
<body>

<div id="map"></div>
<div id="control-panel" class="floating-panel">
    <h4><i class="fa-solid fa-magnifying-glass" style="margin-right: 8px;"></i>Risk Analysis</h4>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="e.g., Sibu, Sarawak">
        <button id="search-button" title="Search Location"><i class="fa-solid fa-search"></i></button>
    </div>
    <div id="action-tooltip"></div>
    <p class="instructions" id="instructions">Click on the map to unlock SAR analysis.</p>
</div>
<div id="result-panel" class="floating-panel"></div>
<div id="forecast-panel" class="floating-panel">
    <div class="daily-forecast-container" id="daily-forecast-container"></div>
    <div class="hourly-forecast-container" id="hourly-forecast-container"></div>
</div>
<div id="layer-panel" class="floating-panel">
    <ul class="layer-list" id="layer-list"></ul>
</div>
<div id="status-overlay"></div>

<!-- [Final Fix] Move the entire SCRIPT tag to the end of the BODY -->
<script>
    // --- Configuration ---
    const API_BASE_URL = 'http://127.0.0.1:8000';
    // [IMPORTANT!] Paste your free API Key from OpenWeatherMap here.
    const OWM_API_KEY = '5f66e14d6562958e2f9fb986b4fc8bdf'; 

    // --- Map Initialization ---
    const map = L.map('map', { zoomControl: false }).setView([4.21, 101.97], 6);
    L.control.zoom({ position: 'topright' }).addTo(map);
    const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);

    // --- Global State & UI Elements ---
    let activeLayers = {}, clickMarker = null, fullForecastData = null, temperatureLayerGroup = L.layerGroup().addTo(map);
    const statusOverlay = document.getElementById('status-overlay');
    const resultPanel = document.getElementById('result-panel');
    const forecastPanel = document.getElementById('forecast-panel');
    const layerPanel = document.getElementById('layer-panel');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    
    // --- UI/UX Functions ---
    // The code for these functions is identical to the previous version, just moved to the correct location.
    
    // [V7.2 Final] Upgraded function using the correct 'find' API endpoint and better styling.
    let debounceTimer;
    async function updateLiveTemperatures() {
        if (!OWM_API_KEY || OWM_API_KEY === 'YOUR_OPENWEATHERMAP_API_KEY') return;
        
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const center = map.getCenter();
            const lat = center.lat;
            const lon = center.lng;
            
            try {
                // Increase count to 50 for more density
                const response = await fetch(`https://api.openweathermap.org/data/2.5/find?lat=${lat}&lon=${lon}&cnt=50&appid=${OWM_API_KEY}&units=metric`);
                if (!response.ok) return;
                const data = await response.json();
                
                temperatureLayerGroup.clearLayers();
                if (data.list) {
                    data.list.forEach(city => {
                        const tempIcon = L.divIcon({
                            className: 'temperature-label',
                            html: `<div>${Math.round(city.main.temp)}°</div><span class="city-name">${city.name}</span>`
                        });
                        L.marker([city.coord.lat, city.coord.lon], { icon: tempIcon }).addTo(temperatureLayerGroup);
                    });
                }
            } catch (error) {
                console.error("Failed to fetch live temperatures:", error);
            }
        }, 500);
    }
    
    // --- Main Analysis Logic & Event Listeners ---
    map.on('moveend', updateLiveTemperatures);
    map.on('zoomend', updateLiveTemperatures);
    
    // This is the key change: All JS code runs after the DOM is fully loaded.
    document.addEventListener('DOMContentLoaded', () => {
        initializeUI();
        updateLiveTemperatures(); 
    });

    // All other JS functions are placed here, inside the script tag, after the DOM element variables are defined.
    function initializeUI(){const e=document.getElementById("layer-list");e.innerHTML="";const t=[];OWM_API_KEY&&"YOUR_OPENWEATHERMAP_API_KEY"!==OWM_API_KEY?(activeLayers.precip=L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OWM_API_KEY}`,{opacity:.65}),activeLayers.temp=L.tileLayer(`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${OWM_API_KEY}`,{opacity:.65}),t.push({id:"precip",name:"Forecast: Precipitation",icon:"fa-cloud-showers-heavy",inactive:!1},{id:"temp",name:"Forecast: Temperature",icon:"fa-temperature-half",inactive:!1})):void 0,t.push({id:"sar",name:"Historical Flood (SAR)",icon:"fa-water",inactive:!0}),t.push({id:"aoi",name:"Area of Interest",icon:"fa-draw-polygon",inactive:!0}),t.forEach(t=>{const a=document.createElement("li");a.className=`layer-item ${t.inactive?"inactive":""}`,a.dataset.layerId=t.id,a.innerHTML=`<i class="fa-solid ${t.icon}"></i> ${t.name}`,t.inactive&&(a.title="Click on the map to activate this layer"),a.addEventListener("click",()=>toggleLayer(t.id)),e.appendChild(a)}),layerPanel.classList.add("visible")}function showActionTooltip(e){const t=document.getElementById("action-tooltip");t.textContent=e,t.style.opacity="1",t.style.transform="translateY(0)",setTimeout(()=>{t.style.opacity="0",t.style.transform="translateY(-20px)"},3e3)}function toggleLayer(e){const t=document.querySelector(`.layer-item[data-layer-id="${e}"]`);if(t.classList.contains("inactive"))return void showActionTooltip("Click on the map first to activate this layer.");document.querySelectorAll("#layer-list .layer-item").forEach(t=>{const a=t.dataset.layerId;"aoi"!==a&&(a===e?(t.classList.add("active"),activeLayers[a]&&!map.hasLayer(activeLayers[a])&&map.addLayer(activeLayers[a])):(t.classList.remove("active"),activeLayers[a]&&map.hasLayer(activeLayers[a])&&map.removeLayer(activeLayers[a])))}),"aoi"===e&&(t.classList.toggle("active"),map.hasLayer(activeLayers.aoi)?map.removeLayer(activeLayers.aoi):map.addLayer(activeLayers.aoi))}function showStatus(e){statusOverlay.innerHTML=`<span class="loader"></span> ${e}`,statusOverlay.style.display="flex",resultPanel.classList.remove("visible"),forecastPanel.classList.remove("visible")}function hideStatus(){statusOverlay.style.display="none"}function displayResults(e){const{result:t,request_data:a}=e;if(!t)return hideStatus(),resultPanel.innerHTML=`<div class="location-title">${a.locationName}</div><div class="evidence-details"><p><strong>Error:</strong> Analysis returned no result.</p></div>`,void resultPanel.classList.add("visible");const{risk_assessment:l,weather_forecast:s}=t,o=a.locationName||"Selected Area";resultPanel.innerHTML=`\n            <div class="location-title">${o}</div>\n            <div class="risk-summary risk-${l.risk_level.toLowerCase()}">\n                <h2>${l.risk_level} Risk</h2><p>Confidence: ${l.confidence}</p>\n            </div>\n            <div class="evidence-details">\n                <p>${l.summary.replace(/\*\*/g,"<strong>")}</p>\n                <h4><i class="fa-solid fa-satellite-dish"></i> Historical Vulnerability (SAR)</h4>\n                <p>${l.evidence.historical_vulnerability}</p>\n                <h4><i class="fa-solid fa-cloud-sun-rain"></i> Future Threat (Weather)</h4>\n                <p>${l.evidence.future_threat}</p>\n            </div>\n        `,resultPanel.classList.add("visible"),s&&s.success&&(forecastPanel.classList.add("visible"),populateForecastPanel(s)),activateAnalysisLayers(t)}
    function activateAnalysisLayers(e){const{historical_context:t}=e;activeLayers.sar=L.tileLayer(t.tile_url,{opacity:.75}),activeLayers.aoi=L.geoJSON(e.analyzed_geojson,{style:{color:"#ff7800",weight:3,fillOpacity:0}});const a=document.querySelector('.layer-item[data-layer-id="sar"]'),l=document.querySelector('.layer-item[data-layer-id="aoi"]');a&&a.classList.remove("inactive"),l&&l.classList.remove("inactive"),Object.values(activeLayers).forEach(e=>{e&&map.hasLayer(e)&&map.removeLayer(e)}),map.addLayer(activeLayers.aoi),l.classList.add("active"),toggleLayer("sar"),map.fitBounds(activeLayers.aoi.getBounds(),{padding:[50,50]})}function getWeatherIconClass(e){return e>=200&&e<300?"fa-solid fa-cloud-bolt":e>=300&&e<600?"fa-solid fa-cloud-rain":e>=600&&e<700?"fa-solid fa-snowflake":800===e?"fa-solid fa-sun":801===e||802===e?"fa-solid fa-cloud-sun":803===e||804===e?"fa-solid fa-cloud":"fa-solid fa-smog"}
    function populateForecastPanel(e){if(!e||!e.success)return;fullForecastData=e.data;const t=document.getElementById("daily-forecast-container");t.innerHTML="";fullForecastData.daily.time.forEach((e,a)=>{const l=document.createElement("div");l.className="day-forecast",l.dataset.dayIndex=a;const s=(new Date(e)).toLocaleDateString("en-US",{weekday:"short"});l.innerHTML=`\n                <div class="day-name">${0===a?"Today":s}</div>\n                <i class="weather-icon ${getWeatherIconClass(fullForecastData.daily.weathercode[a])}"></i>\n                <div class="temp-range">${Math.round(fullForecastData.daily.temperature_2m_max[a])}°/${Math.round(fullForecastData.daily.temperature_2m_min[a])}°</div>\n            `,l.addEventListener("click",()=>{document.querySelectorAll(".day-forecast").forEach(e=>e.classList.remove("active")),l.classList.add("active"),showHourlyForecast(a)}),t.appendChild(l)}),t.firstChild&&t.firstChild.click()}
    function showHourlyForecast(e){const t=document.getElementById("hourly-forecast-container");if(!fullForecastData.hourly)return t.innerHTML='<p style="text-align:center;width:100%;">Hourly data not available.</p>',void t.classList.add("visible");t.innerHTML="";const a=24*e,l=a+24,s=fullForecastData.hourly.time.slice(a,l),o=fullForecastData.hourly.temperature_2m.slice(a,l);s.forEach((e,r)=>{const n=document.createElement("div");n.className="hour-forecast";const i=(new Date(e)).getHours();n.innerHTML=`\n                <div class="hour-time">${i}:00</div>\n                <i class="weather-icon ${getWeatherIconClass(fullForecastData.hourly.weathercode[a+r])}"></i>\n                <div class="hour-temp">${Math.round(o[r])}°</div>\n            `,t.appendChild(n)}),t.classList.add("visible")}
    async function triggerAnalysis(e,t,a){showStatus(`Analyzing for ${a}...`);try{const l=await fetch(`${API_BASE_URL}/api/v7/analyze_on_click`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lat:e,lon:t,buffer_degree:.1})});if(!l.ok)throw new Error(`API submit failed with status ${l.status}`);const s=await l.json(),o=`${API_BASE_URL}${s.status_endpoint}`,r=async e=>{const t=await fetch(e),a=await t.json();return"COMPLETED"===a.status||"FAILED"===a.status?a:(await new Promise(resolve=>setTimeout(resolve,3e3)),r(e))},n=await r(o);hideStatus(),"COMPLETED"===n.status?(n.request_data.locationName=a,displayResults(n)):(()=>{throw new Error(n.result.error)})()}catch(e){hideStatus(),resultPanel.innerHTML=`<div class="location-title">${a}</div><div class="evidence-details"><p><strong>Error:</strong> ${e.message}</p></div>`,resultPanel.classList.add("visible")}}
    map.on("click",async e=>{const{lat:t,lng:a}=e.latlng;clickMarker&&map.removeLayer(clickMarker),clickMarker=L.marker([t,a]).addTo(map);try{const l=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${a}&accept-language=en`);if(!l.ok)throw new Error("Reverse geocoding service unavailable.");const s=await l.json(),o=s.display_name||"Unknown Location";triggerAnalysis(t,a,o)}catch(e){triggerAnalysis(t,a,`Area @ ${t.toFixed(2)}, ${a.toFixed(2)}`)}});
    async function searchLocation(){const e=searchInput.value;if(!e)return;showStatus(`Searching for ${e}...`);try{const t=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(e)}&format=json&limit=1&accept-language=en`);if(!t.ok)throw new Error("Search service unavailable.");const a=await t.json();if(a&&a.length>0){const{lat:e,lon:t,display_name:l}=a[0],s=parseFloat(e),o=parseFloat(t);clickMarker&&map.removeLayer(clickMarker),clickMarker=L.marker([s,o]).addTo(map),map.setView([s,o],11),triggerAnalysis(s,o,l)}else hideStatus(),resultPanel.innerHTML=`<p style="padding: 15px; text-align: center;">Error: Location "<strong>${e}</strong>" not found.</p>`,resultPanel.classList.add("visible")}catch(e){hideStatus(),resultPanel.innerHTML=`<p style="padding: 15px; text-align: center;">Error: Search service failed. Please try again later.</p>`,resultPanel.classList.add("visible")}}
    searchButton.addEventListener("click",searchLocation),searchInput.addEventListener("keydown",e=>{"Enter"===e.key&&searchLocation()});
    function resetDashboard(){resultPanel.classList.remove("visible"),forecastPanel.classList.remove("visible"),clickMarker&&map.removeLayer(clickMarker),Object.values(activeLayers).forEach(e=>{e&&map.hasLayer(e)&&map.removeLayer(e)}),activeLayers={},clickMarker=null,document.getElementById("search-input").value="",initializeUI()}document.addEventListener("keydown",function(e){"Escape"===e.key&&(statusOverlay.style.display!=="none"||resetDashboard())});
</script>

</body>
</html>